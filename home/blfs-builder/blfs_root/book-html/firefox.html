<?xml version="1.0" encoding="ISO-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" /><title>Firefox-91.0.1</title><link rel="stylesheet" type="text/css" href="stylesheets/lfs.css" /><meta name="generator" content="DocBook XSL-NS Stylesheets Vsnapshot" /><link rel="stylesheet" href="stylesheets/lfs-print.css" type="text/css" media="print" /></head><body class="blfs" id="blfs-11.0"><div class="navheader"><h4>Beyond Linux<sup>®</sup> From Scratch 
  
  <span class="phrase">(System V</span> Edition) - Version 11.0</h4><h3>Chapter 1. Installing packages in dependency build order</h3><ul><li class="prev"><a accesskey="p" href="zip.html" title="Zip-3.0">Prev</a><p>Zip-3.0</p></li><li class="next"><a accesskey="n" href="appendices/creat-comm.html" title="Creative Commons License">Next</a><p>Creative Commons License</p></li><li class="up"><a accesskey="u" href="ch01.html" title="Chapter 1. Installing packages in dependency build order">Up</a></li><li class="home"><a accesskey="h" href="index.html" title="Beyond Linux® From Scratch &#10;  &#10;  (System V Edition) - Version 11.0">Home</a></li></ul></div><div class="sect1" lang="en" xml:lang="en"><h1 class="sect1"><a id="firefox" name="firefox"></a>Firefox-91.0.1</h1><div class="package" lang="en" xml:lang="en"><h2 class="sect2">Introduction to Firefox</h2><p>
      <span class="application">Firefox</span> is a stand-alone browser based on the
      <span class="application">Mozilla</span> codebase.
    </p><p>This package is known to build and work
                              properly using an LFS-11.0 platform.</p><h3>Package Information</h3><div class="itemizedlist"><ul class="compact"><li class="listitem"><p>
          Download (HTTP): <a class="ulink" href="https://archive.mozilla.org/pub/firefox/releases/91.0.1esr/source/firefox-91.0.1esr.source.tar.xz">https://archive.mozilla.org/pub/firefox/releases/91.0.1esr/source/firefox-91.0.1esr.source.tar.xz</a>
        </p></li><li class="listitem"></li><li class="listitem"><p>
          Download MD5 sum: f81ca2f266ab3dafdd080f269bbb2286
        </p></li><li class="listitem"><p>
          Download size: 366 MB
        </p></li><li class="listitem"><p>
          Estimated disk space required: 6.7 GB (196 MB installed) without tests
        </p></li><li class="listitem"><p>
          Estimated build time: 28 SBU (on a typical 4-core machine) without tests
        </p></li></ul></div><h3>Additional Downloads</h3><div class="itemizedlist"><ul class="compact"><li class="listitem"><p>
          Required patch:
          <a class="ulink" href="https://www.linuxfromscratch.org/patches/blfs/11.0/firefox-91.0.1esr-glibc234-1.patch">https://www.linuxfromscratch.org/patches/blfs/11.0/firefox-91.0.1esr-glibc234-1.patch</a>
        </p></li><li class="listitem"><p>
          Recommended patch:
          <a class="ulink" href="https://www.linuxfromscratch.org/patches/blfs/11.0/firefox-91.0.1esr-disable_rust_test-1.patch">https://www.linuxfromscratch.org/patches/blfs/11.0/firefox-91.0.1esr-disable_rust_test-1.patch</a>
        </p></li></ul></div><div class="admon note"><img alt="[Note]" src="images/note.png" /><h3>Note</h3><p>
        With the 91 ESR series, firefox no-longer works on ftp: links.
        If that is important to you, as a temporary measure (on non-glibc-2.34
        systems) you can continue to use firefox-legacy (in full book)
              
        while you explore alternative approaches.
      </p><p>
        The directory name is firefox-91.0.1
      </p><p>
        Extracting the tarball
        will reset the permissions of the current directory to 0755 if you
        have permission to do that. If you do this in a directory where
        the sticky bit is set, such
        as <code class="filename">/tmp</code> it will end with error
        messages:
      </p><div class="literallayout"><p>tar: .: Cannot utime: Operation not permitted<br />
tar: .: Cannot change mode to rwxr-xr-t: Operation not permitted<br />
tar: Exiting with failure status due to previous errors<br />
</p></div><p>
        This does finish with non-zero status, but it does
        <span class="emphasis"><em>NOT</em></span> mean there is a real problem.
        Do not untar as the <code class="systemitem">root</code> user
        in a directory where the sticky bit is set - that will unset it.
      </p><p>
        As with other large packages which use C++ (or rust), the SBU times
        to build this vary more widely than you might expect. The build times
        will increase significantly if your machine has to swap.
      </p><p>
        Although upstream prefer to use <span class="application">PulseAudio</span>,
        for the moment <span class="application">Alsa</span> can still be used. Both
        may need runtime configuration to get sound working.
      </p></div><h3>Firefox Dependencies</h3><h4>Required</h4><p class="required">
      autoconf213 (in full book)
              ,
      <a class="xref" href="cbindgen.html" title="Cbindgen-0.20.0">Cbindgen-0.20.0</a>,
      dbus-glib (in full book)
              ,
      both gtk3 (in full book)
               and
      gtk2 (in full book)
              ,
      libnotify (in full book)
              ,
      llvm (in full book)
               (clang, used for bindgen even if using gcc),
      <a class="xref" href="nodejs.html" title="Node.js-14.17.5">nodejs-14.17.5</a>,
      nss (in full book)
              ,
      <a class="xref" href="pulseaudio.html" title="PulseAudio-15.0">PulseAudio-15.0</a>
      (or
      alsa-lib (in full book)
               if you edit the mozconfig;
        now deprecated by mozilla), in either case please read the
        Configuration Information,
      
      <a class="xref" href="python3.html" title="Python-3.9.6">Python-3.9.6</a> (rebuilt after installing sqlite (in full book)
              ),
      <a class="xref" href="startup-notification.html" title="startup-notification-0.12">startup-notification-0.12</a>,
      unzip (in full book)
              ,
      yasm (in full book)
              , and
      <a class="xref" href="zip.html" title="Zip-3.0">Zip-3.0</a>
    </p><h4>Recommended</h4><p class="recommended">
      icu (in full book)
              ,
      libevent (in full book)
              ,
      libwebp (in full book)
              ,
      nasm (in full book)
              
    </p><div class="admon note"><img alt="[Note]" src="images/note.png" /><h3>Note</h3><p>
        If you don't install recommended dependencies, then internal copies of
        those packages will be used. They might be tested to work, but they can
        be out of date or contain security holes.
      </p></div><h4>Optional</h4><p class="optional">
      curl (in full book)
              ,
      doxygen (in full book)
              ,
      ffmpeg (in full book)
               (runtime, to play mov, mp3 or mp4 files),
      
      liboauth (in full book)
              ,
      openjdk (in full book)
              ,
      valgrind (in full book)
              ,
      wget (in full book)
              ,
      wireless_tools (in full book)
              ,
      <a class="ulink" href="https://github.com/libproxy/libproxy">libproxy</a>
    </p><p class="usernotes">
      User Notes: <a class="ulink" href="https://wiki.linuxfromscratch.org/blfs/wiki/firefox">https://wiki.linuxfromscratch.org/blfs/wiki/firefox</a>
    </p></div><div class="installation" lang="en" xml:lang="en"><h2 class="sect2">Installation of Firefox</h2><p>
      The configuration of <span class="application">Firefox</span> is accomplished
      by creating a <code class="filename">mozconfig</code> file containing the desired
      configuration options. A default <code class="filename">mozconfig</code> is
      created below. To see the entire list of available configuration options
      (and an abbreviated description of some of them), issue <span class="command"><strong>./mach
      configure &amp;&amp; ./configure --help | less</strong></span>. You may also
      wish to review the entire file and uncomment any other desired options.
      Create the file by issuing the following command:
    </p><pre class="userinput"><kbd class="command">cat &gt; mozconfig &lt;&lt; "EOF"
<code class="literal"># If you have a multicore machine, all cores will be used by default.

# If you have installed (or will install) wireless-tools, and you wish
# to use geolocation web services, comment out this line
ac_add_options --disable-necko-wifi

# API Keys for geolocation APIs - necko-wifi (above) is required for MLS
# Uncomment the following line if you wish to use Mozilla Location Service
#ac_add_options --with-mozilla-api-keyfile=$PWD/mozilla-key

# Uncomment the following line if you wish to use Google's geolocaton API
# (needed for use with saved maps with Google Maps)
#ac_add_options --with-google-location-service-api-keyfile=$PWD/google-key

# startup-notification is required since firefox-78

# Uncomment the following option if you have not installed PulseAudio
#ac_add_options --disable-pulseaudio
# or uncomment this if you installed alsa-lib instead of PulseAudio
#ac_add_options --enable-alsa

# Uncomment this line if you are building on an i686 system to fix a build
# failure due to invalid ASM code.
#ac_add_options --with-system-libvpx

# Comment out following options if you have not installed
# recommended dependencies:
ac_add_options --with-system-libevent
ac_add_options --with-system-webp
ac_add_options --with-system-nspr
ac_add_options --with-system-nss
ac_add_options --with-system-icu

# Do not specify the gold linker which is not the default. It will take
# longer and use more disk space when debug symbols are disabled.

# libdavid (av1 decoder) requires nasm. Uncomment this if nasm
# has not been installed.
#ac_add_options --disable-av1

# You cannot distribute the binary if you do this
ac_add_options --enable-official-branding

# Stripping is now enabled by default.
# Uncomment these lines if you need to run a debugger:
#ac_add_options --disable-strip
#ac_add_options --disable-install-strip

# Disabling debug symbols makes the build much smaller and a little
# faster. Comment this if you need to run a debugger. Note: This is
# required for compilation on i686.
ac_add_options --disable-debug-symbols

# The elf-hack is reported to cause failed installs (after successful builds)
# on some machines. It is supposed to improve startup time and it shrinks
# libxul.so by a few MB - comment this if you know your machine is not affected.
ac_add_options --disable-elf-hack

# The BLFS editors recommend not changing anything below this line:
ac_add_options --prefix=/usr
ac_add_options --enable-application=browser
ac_add_options --disable-crashreporter
ac_add_options --disable-updater
# enabling the tests will use a lot more space and significantly
# increase the build time, for no obvious benefit.
ac_add_options --disable-tests

# The default level of optimization again produces a working build with gcc.
ac_add_options --enable-optimize

ac_add_options --enable-system-ffi
ac_add_options --enable-system-pixman

ac_add_options --with-system-jpeg
ac_add_options --with-system-png
ac_add_options --with-system-zlib

# The following option unsets Telemetry Reporting. With the Addons Fiasco,
# Mozilla was found to be collecting user's data, including saved passwords and
# web form data, without users consent. Mozilla was also found shipping updates
# to systems without the user's knowledge or permission.
# As a result of this, use the following command to permanently disable
# telemetry reporting in Firefox.
unset MOZ_TELEMETRY_REPORTING

mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/firefox-build-dir</code>
EOF</kbd></pre><p>
      Compile <span class="application">Firefox</span> by issuing the following
      commands:
    </p><p>
      Apply a patch which allows compilation on systems running glibc-2.34:
    </p><pre class="userinput"><kbd class="command">patch -Np1 -i ../firefox-91.0.1esr-glibc234-1.patch</kbd></pre><p>
      Now apply a patch which works around unexplained failures on some machines
      (a message that a python check on libgkrust.a identified 1 networking
      function, getsockname) in the rust static library.
    </p><pre class="userinput"><kbd class="command">patch -Np1 -i ../firefox-91.0.1esr-disable_rust_test-1.patch</kbd></pre><p>
      If the geolocation APIs are needed:
    </p><div class="admon note"><img alt="[Note]" src="images/note.png" /><h3>Note</h3><p>
        
        The Google and Mozilla API Keys below are specific to LFS. If using
        these instructions for another distro, or if you intend to distribute
        binary copies of the software using these instructions, please obtain
        your own keys following the instructions located at
        <a class="ulink" href="http://www.chromium.org/developers/how-tos/api-keys">http://www.chromium.org/developers/how-tos/api-keys</a> and
        <a class="ulink" href="https://location.services.mozilla.com/api">https://location.services.mozilla.com/api</a> respectively.
        
      </p></div><pre class="userinput"><kbd class="command">echo "AIzaSyDxKL42zsPjbke5O8_rPVpVrLrJ8aeE9rQ" &gt; google-key
echo "613364a7-9418-4c86-bcee-57e32fd70c23" &gt; mozilla-key</kbd></pre><div class="admon note"><img alt="[Note]" src="images/note.png" /><h3>Note</h3><p>
      If you are compiling this package in chroot you must do two things.
      First, as the <code class="systemitem">root</code> user,
      ensure that <code class="filename">/dev/shm</code> is mounted. If you do not
      do this, the <span class="application">Python</span> configury will fail
      with a traceback report referencing
      <code class="filename">/usr/lib/pythonN.N/multiprocessing/synchronize.py</code>.
      Run:

</p><pre class="userinput"><kbd class="command">mountpoint -q /dev/shm || mount -t tmpfs devshm /dev/shm</kbd></pre><p>

    </p><p>
      Second, either as the <code class="systemitem">root</code>
      user export the <code class="envar">$SHELL</code> environment variable using
      <span class="command"><strong>export SHELL=/bin/sh</strong></span> or else prepend
      <code class="envar">SHELL=/bin/sh</code> when running the
      <span class="command"><strong>./mach</strong></span> commands.
    </p></div><p>
      Now invoke the Python <span class="command"><strong>mach</strong></span> script to compile the package.
    </p><pre class="userinput"><kbd class="command">export CC=gcc CXX=g++ &amp;&amp;
export MACH_USE_SYSTEM_PYTHON=1            &amp;&amp;
export MOZBUILD_STATE_PATH=${PWD}/mozbuild &amp;&amp;
./mach configure                           &amp;&amp;
./mach build</kbd></pre><p>
      The <code class="filename">mozconfig</code> above disables the tests because
      they use a lot more time and disk space for no obvious benefit. If
      you have nevertheless enabled them, you can run the tests by executing
      <span class="command"><strong>./mach gtest</strong></span>. This will require a network connection,
      and to be run from within an Xorg session - there is a popup dialog
      when it fails to connect to ALSA (that does not create a failed test).
      One or two tests will fail.  To see the details of the failure(s) you
      will need to log the output from that command so that you can review it.
    </p><p>
      Now, as the <code class="systemitem">root</code> user:
    </p><pre class="root"><kbd class="command">MACH_USE_SYSTEM_PYTHON=1 ./mach install</kbd></pre><p>
      Empty the environment variables which were set above:
    </p><pre class="userinput"><kbd class="command">unset CC CXX MACH_USE_SYSTEM_PYTHON MOZBUILD_STATE_PATH</kbd></pre></div><div class="commands" lang="en" xml:lang="en"><h2 class="sect2">Command Explanations</h2><p>
      <span class="command"><strong>export CC=gcc CXX=g++ ...</strong></span>: Upstream now prefer
      <span class="application">clang</span> so that they can use one compiler
      everywhere. On the X86 architectures <span class="application">clang</span>
      now appears to support most of the same security-hardening options as
      <span class="application">GCC</span>.
      
      With the current versions and the default flags,
      <span class="application">GCC</span> creates a marginally bigger build but
      takes typically 2 SBU less time on a 4-core machine using the mozconfig
      above.
    </p><p>
      <span class="command"><strong>export MOZBUILD_STATE_PATH=${PWD}/mozbuild</strong></span>: The build
      is now supposed to tell you that it intends to create <code class="filename">~/.mozbuild</code>, and offer you an option to
      press &lt;ENTER&gt; to accept this, or Ctrl-C to cancel and restart the
      build after specifying the directory. In practice, the message may not
      appear until after &lt;ENTER&gt; is keyed, i.e. the build stalls.
    </p><p>
      That directory is used for a (probably random) telemetry identifier.
      Creating this in the build directory, and deleting that after the
      installation, prevents it being used. If you wish to participate in
      telemetry, export MOZBUILD_STATE_PATH to point to its default directory
      and remove the entry from the <code class="filename">mozconfig</code>.
    </p><p>
      <span class="command"><strong>MACH_USE_SYSTEM_PYTHON=1</strong></span>: Use the system python
      to create a virtual environment for <span class="command"><strong>mach</strong></span> without
      downloading any python wheels.
    </p><p>
      <span class="command"><strong>./mach configure</strong></span>: This validates the supplied
      dependencies and the <code class="filename">mozconfig</code>.
    </p><p>
      <code class="option">./mach build --verbose</code>: Use this alternative if you
      need details of which files are being compiled, together with any C or
      C++ flags being used. But do not add '--verbose' to the install command,
      it is not accepted there.
    </p><p>
      <code class="option">./mach build -jN</code>: The build should, by default, use
      all the online CPU cores. If using all the cores causes the build to swap
      because you have insufficient memory, using fewer cores can be faster.
    </p></div><div class="configuration" lang="en" xml:lang="en"><h2 class="sect2">Configuring Firefox</h2><p>
      If you use a desktop environment like <span class="application">Gnome</span> or
      <span class="application">KDE</span> you may like to create a
      <code class="filename">firefox.desktop</code> file so that
      <span class="application">Firefox</span> appears in the panel's menus.  As the
      <code class="systemitem">root</code> user:
    </p><pre class="root"><kbd class="command">mkdir -pv /usr/share/applications &amp;&amp;
mkdir -pv /usr/share/pixmaps      &amp;&amp;

MIMETYPE="text/xml;text/mml;text/html;"                                    &amp;&amp;
MIMETYPE="$MIMETYPE;application/xhtml+xml;application/vnd.mozilla.xul+xml" &amp;&amp;
MIMETYPE="$MIMETYPE;x-scheme-handler/http;x-scheme-handler/https;          &amp;&amp;

cat &gt; /usr/share/applications/firefox.desktop &lt;&lt; EOF &amp;&amp;
<code class="literal">[Desktop Entry]
Encoding=UTF-8
Name=Firefox Web Browser
Comment=Browse the World Wide Web
GenericName=Web Browser
Exec=firefox %u
Terminal=false
Type=Application
Icon=firefox
Categories=GNOME;GTK;Network;WebBrowser;
MimeType=$MIMETYPE
StartupNotify=true</code>
EOF

unset MIMETYPE &amp;&amp;

ln -sfv /usr/lib/firefox/browser/chrome/icons/default/default128.png \
        /usr/share/pixmaps/firefox.png</kbd></pre><div class="sect3" lang="en" xml:lang="en"><h3 class="sect3"><h4 class="title"><a id="idm140561555971296"></a>Configuration Information</h4></h3><p>
        The application settings for firefox are accessible by keying
        <span class="command"><strong>about:config</strong></span> in the address bar.
      </p><p>
        Occasionally, getting working sound in
        <span class="application">firefox</span> can be a problem.  Although upstream
        prefers pulseaudio,
        on balance using <span class="application">Alsa</span> may be easier.
      </p><p>
        If you enabled <span class="application">Alsa</span> for sound, you may need
        to alter one variable to get working sound. If you run
        <span class="command"><strong>firefox</strong></span> from a term and try to play something with
        sound you might encounter error messages like:
      </p><p>
         <code class="literal">Sandbox: seccomp sandbox violation: pid 3941, tid 4030,
         syscall 16, args 48 2147767296 139909894784796 0 0 0.</code>
      </p><p>
        That was on x86_64, on i686 the syscall number is 54. To allow this
        syscall, in <span class="command"><strong>about:config</strong></span> change
        <span class="command"><strong>security.sandbox.content.syscall_whitelist</strong></span> to 16
        (or 54 if using i686).
      </p><p>
        If you use <span class="command"><strong>pulseaudio</strong></span> in a Desktop Environment, it
        might already be started by that DE.  But if it is not, although
        firefox-57 managed to start it, firefox-58 did not.  If you run
        <span class="command"><strong>firefox</strong></span> from a term and this problem is present,
        trying to play sound will
        encounter error messages warning <code class="literal">Can't get cubeb
        context!</code>
      </p><p>
      The fix for this is to close firefox, start pulseaudio to check it
      does start (if not, read the information on Configuring in <a class="xref" href="pulseaudio.html" title="PulseAudio-15.0">PulseAudio-15.0</a>) and restart firefox to check it is working.
      If it now works, add the following to your <code class="filename">~/.xinitrc</code>:
<span class="phrase">
<code class="literal">pulseaudio --verbose --log-target=syslog&amp;</code></span>

        (unfortunately, on some systems this does not work).
      </p><p>
        You may wish to use multiple profiles within firefox. To do that, invoke
        firefox as <span class="command"><strong>firefox --ProfileManager</strong></span>. You can also
        check which profile is currently in use from
        <span class="command"><strong>about:profiles</strong></span>.
      </p><p>
        Although WebRender (using the GPU for compositing) is not used by
        default, it now appears to work well on supported hardware (ATI, Nvidia
        and Intel GPUs with Mesa-18 or later. For an explanation, please see
        <a class="ulink" href="https://hacks.mozilla.org/2017/10/the-whole-web-at-maximum-fps-how-webrender-gets-rid-of-jank/">hacks.mozilla.org</a>.
       The only downside seems to be that on a machine with limited RAM it might
       use more RAM.
     </p><p>
      To check if WebRender is being used, look in about:support. In the Graphics
      section Compositing will either show 'Basic' (i.e. not in use) or
      'WebRender'. To enable it, go to about:config and change gfx.webrender.all
      to True. You will need to restart firefox.
    </p><p>
      It may be useful to mention the processes from firefox which can appear in
      <span class="command"><strong>top</strong></span> - as well as firefox itself, there may be multiple
      Web Content processes, and now an RDD Process (Remote Data Decoder) which
      appears when playing web videos encoded with av1 (libdav1d). If WebRender
      has been enabled, a GPU Process will also appear when firefox has to
      repaint (e.g. scrolling, opening a new tab, or playing a video).
    </p></div></div><div class="content" lang="en" xml:lang="en"><h2 class="sect2">Contents</h2><div class="segmentedlist"><div class="seglistitem"><div class="seg"><strong class="segtitle">Installed Programs: </strong><span class="segbody">
          firefox
        </span></div><div class="seg"><strong class="segtitle">Installed Libraries: </strong><span class="segbody">
          Numerous libraries, browser components, plugins, extensions, and
          helper modules installed in /usr/lib/firefox
        </span></div><div class="seg"><strong class="segtitle">Installed Directory: </strong><span class="segbody">
	  /usr/lib/firefox and /usr/lib/mozilla
        </span></div></div></div><div class="variablelist"><h3>Short Descriptions</h3><table border="0" class="variablelist"><colgroup><col align="left" valign="top" /><col /></colgroup><tbody><tr><td><p><a id="firefox-prog"></a><span class="term"><span class="command"><strong>firefox</strong></span></span></p></td><td><p>
	    is a <span class="application">GTK+-3</span> internet browser that uses
	    the Mozilla Gecko rendering engine
          </p></td></tr></tbody></table></div></div><p class="updated">Last updated 
      on
      </p></div><div class="navfooter"><ul><li class="prev"><a accesskey="p" href="zip.html" title="Zip-3.0">Prev</a><p>Zip-3.0</p></li><li class="next"><a accesskey="n" href="appendices/creat-comm.html" title="Creative Commons License">Next</a><p>Creative Commons License</p></li><li class="up"><a accesskey="u" href="ch01.html" title="Chapter 1. Installing packages in dependency build order">Up</a></li><li class="home"><a accesskey="h" href="index.html" title="Beyond Linux® From Scratch &#10;  &#10;  (System V Edition) - Version 11.0">Home</a></li></ul></div></body></html>